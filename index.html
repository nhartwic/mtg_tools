<html>
  <head>
    <link rel="stylesheet" href="./static/css/bootstrap.min.css" media="screen">
    <link rel="stylesheet" href="./static/css/styles.css" media="screen">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="static/js/sorttable.js"></script>
  </head>
  <body>
          <!-- Start of navbar -->
    <nav class="navbar navbar-default">
      <div class="container-fluid navbar-custom">

        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="row">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle Navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="col-xs-9 phone-nav">
              <a class="navbar-brand" href="#" id="logo">MTG Set Images and Data</a>
            </div>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right navbar-right-custom">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Sets <span class="caret"></span></a>
                <ul class="dropdown-menu" style="max-height:250px; overflow:auto">
                </ul>
              </li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div>
      </div><!-- /.container-fluid -->
    </nav>
    <!-- End of navbar -->



    <div class="container image_field" style="width:100%;max-width:none;padding:1%;">
    </div>

    <div class="container table-responsive" style="width:100%;max-width:none;padding:5%;">
      <table class="table thead-dark table-striped table-bordered">
      </table>
    </div>
    <!-- Bootstrap CDN -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    
    <script type="text/javascript">
      // define starting set and URL for set information
      const URL = "https://api.scryfall.com/sets/"
      const start_set = "rna"

      function remove_dups(some_list){
        var seen = {}
        return some_list.filter(function(item){
          if(item in seen){return false}
          else {
            seen[item] = true
            return true
          }
        })
      }

      // define key vals
      keys = [
        "name", "mana_cost", "cmc",
        "type_line", "oracle_text", "power",
        "toughness", "loyalty", "rarity",
        "colors", "color_identity",
        "collector_number", "artist", "usd"
      ]

      // Select document objects
      var tbl = d3.select(".table")
      var imf = d3.select(".image_field")
      var dpm = d3.select(".dropdown-menu")
      imf.html("<p>Loading Images</p>")

      function create_table(set_data){
        tbl.html("")
        var head_row = tbl.append("thead").append("tr")
        keys.forEach(function(k){
          head_row.append("th").text(k)
        })
        var body = tbl.append("tbody")
        set_data.forEach(function(card){
          var body_row = body.append("tr")
          keys.forEach(function(k){
            if(k in card){body_row.append("td").text(card[k])}
            else {body_row.append("td").text("")}
          })
        })
        sorttable.makeSortable(tbl.node())
      }


      function clean_cards(set_data){
        var temp = set_data.map(function(card){
          if("card_faces" in card){
            cards = card.card_faces
            var ret = cards.map(function(c){
              keys.forEach(function(k){
                if(!(k in c)){
                  c[k] = card[k]
                }
              })
              if(!("image_uris" in c)){
                c.image_uris = card.image_uris
              }
              return c
            })
            return ret
          }
          else {return [card]}
        })
        return temp.flat()
      }


      function populate_page(set_data){
        set_data = clean_cards(set_data)
        imf.html("")
        var set_uris = set_data.map(x => x.image_uris.normal)
        set_uris = remove_dups(set_uris)
        set_uris.forEach(function (card){
          imf.append("img")
               .attr("src", card)
               .attr("class", "img-responsive")
               .attr("style", "float: left; margin-right: 1%; margin-bottom: 0.5em;")
               .attr("height", 352)
               .attr("width", 252)
        })
        create_table(set_data)
      }

      // Function gets all card data given a set_code then invokes
      // populate_page to reset the page
      function load_set(set_code, sets){
        var set_uri = sets.filter(x => x.code == set_code)[0].search_uri
        var cards = []
        function recursive_read(uri){
          $.ajax({
            url:uri,
            type:"GET",
            success: function(result){
                cards = cards.concat(result.data)
                if(result.has_more){ recursive_read(result.next_page) }
                else { populate_page(cards) }
            }
          })
        }
        recursive_read(set_uri)
      }

      // function performs inital page build once sets query has been
      // Executed
      function init_build(result){
        var set_results = result.data
        var set_codes = set_results.map(x => x.code).sort()

        // populate drop down
        set_codes.forEach( function(x) {
          dpm.append("LI").append("A").text(x).on("click", function(){
            tbl.html("")
            imf.html("<p>Resetting the page</p>")
            load_set(x, set_results)
          })
        })

        // populate page using default set
        load_set(start_set, set_results)
      }

      // Execute initial ajax to fetch set codes and uri then build the page
      $.ajax({
        url: URL,
        type: "GET",
        success: init_build
      })
    </script>
  </body>
</html>